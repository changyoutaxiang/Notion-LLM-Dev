#!/bin/bash

# è·å–åº”ç”¨åŒ…çš„è·¯å¾„
APP_PATH="$(dirname "$(dirname "$(dirname "$(realpath "$0")")")")"
# è·å–é¡¹ç›®æ ¹ç›®å½•
PROJECT_DIR="$(dirname "$APP_PATH")"

# åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd "$PROJECT_DIR"

# è®¾ç½®é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m' 
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}"
echo "==============================================="
echo "          ğŸ¤– Notion-LLM å¼‚æ­¥é€šä¿¡åŠ©æ‰‹"
echo "==============================================="
echo -e "${NC}"

# æ£€æŸ¥Python
if ! command -v python3 &> /dev/null && ! command -v python &> /dev/null; then
    osascript -e 'display alert "Pythonæœªå®‰è£…" message "è¯·å…ˆå®‰è£…Python 3.7+\nä¸‹è½½åœ°å€ï¼šhttps://www.python.org/downloads/" buttons {"ç¡®å®š"} default button "ç¡®å®š"'
    exit 1
fi

# ç¡®å®šPythonå‘½ä»¤
if command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
    PIP_CMD="pip3"
else
    PYTHON_CMD="python"
    PIP_CMD="pip"
fi

echo -e "${GREEN}âœ… Pythonå·²å®‰è£…${NC}"

# æ£€æŸ¥ä¾èµ–åŒ…
echo -e "${YELLOW}ğŸ” æ£€æŸ¥ä¾èµ–åŒ…...${NC}"
if ! $PYTHON_CMD -c "import requests" &> /dev/null; then
    echo -e "${YELLOW}æ­£åœ¨å®‰è£…ä¾èµ–åŒ…...${NC}"
    $PIP_CMD install -r requirements.txt
    if [ $? -ne 0 ]; then
        osascript -e 'display alert "ä¾èµ–åŒ…å®‰è£…å¤±è´¥" message "è¯·æ‰‹åŠ¨è¿è¡Œï¼špip install -r requirements.txt" buttons {"ç¡®å®š"} default button "ç¡®å®š"'
        exit 1
    fi
    echo -e "${GREEN}âœ… ä¾èµ–åŒ…å®‰è£…å®Œæˆ${NC}"
else
    echo -e "${GREEN}âœ… ä¾èµ–åŒ…å·²å®‰è£…${NC}"
fi

echo

# æ£€æŸ¥é…ç½®æ–‡ä»¶
if [ ! -f "config.json" ]; then
    echo -e "${YELLOW}âš ï¸ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºé»˜è®¤é…ç½®${NC}"
fi

echo -e "${BLUE}ğŸš€ æ­£åœ¨å¯åŠ¨ç¨‹åº...${NC}"

# å¯åŠ¨ä¸»ç¨‹åº
$PYTHON_CMD main.py

if [ $? -ne 0 ]; then
    osascript -e 'display alert "ç¨‹åºå¯åŠ¨å¤±è´¥" message "è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶å’Œç½‘ç»œè¿æ¥" buttons {"ç¡®å®š"} default button "ç¡®å®š"'
else
    echo -e "${GREEN}âœ… ç¨‹åºå·²æ­£å¸¸é€€å‡º${NC}"
fi 